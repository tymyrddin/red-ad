# Exploiting Permission Delegation

## Exploiting ACEs

Access Control Entries (ACEs) populate Discretionary Access Control Lists (DACLs). These ACLs determine the 
permissions that certain AD objects have over others. Almost any AD object can be secured with ACEs, which then 
describe the allowed and denied permissions that any other AD object has against the target object.

Certain ACEs can be very dangerous if misconfigured:

* ForceChangePassword: Set a user's password without knowing their current password.
* AddMembers: Add users (including oneself), groups, or computers to a target group.
* GenericAll: Complete control over an object, including the ability to change the user's password, register an SPN 
or add an AD object to the target group.
* GenericWrite: Update any non-protected parameters of our target object. For example, could update the scriptPath 
parameter, which would set a user's logon script.
* WriteOwner:  Update the owner of the target object. Could make ourselves the owner, allowing us to gain additional 
permissions over the object.
* WriteDACL: We have the ability to write new ACEs to the target object's DACL. For example, could write an ACE that 
grants our account full control over the target object.
* AllExtendedRights: Perform any action associated with extended AD rights against the target object. For example, the 
ability to force change a user's password.

## Bloodhound

1. Sharphound has already been executed. The data is in the .zip task file.
2. Launch `neo4j` and `bloodhound` and import the data.

```text
sudo neo4j console &
sudo bloodhound --no-sandbox &
```

3. Drag the .zip file into the Bloodhound window. 
4. Search for our initial account that we retrieved from http://distributor.za.tryhackme.loc/creds

## Privilege Escalation

Look at the info in the Node Info tab, it is pretty obvious that the initial access user does not have many privileges. 
We have the ability to RDP into THMWRK1, but this will only provide us with low-privileged access.

1. Compromise the Tier 2 Admins group (administrative privileges on all workstations).
2. Ask Bloodhound if there is perhaps a road that we can follow to compromise this group (Add your user account as 
the start position and the Tier 2 Admins group as the end position).

An administrator has misconfigured the Permission Delegation of the IT Support group by providing the Domain Users 
group with the AddMembers ACE. This means that any member of the Domain Users group (including our account) can add 
accounts to the IT Support Group. Furthermore, Bloodhound shows that the IT Support Group has the ForceChangePassword 
ACE for the Tier 2 Admins group members. This is not really a misconfiguration since Tier 2 admins are not that 
sensitive, but it provides a very potent attack path when combined with the initial misconfiguration.

    [user.name] --MemberOf -> [Domain Users] --GenericWrite -> [IT Support]

## Add AD account to the IT Support group

Use the Add-ADGroupMember PowerShell cmdlet from the AD-RSAT toolset. 


